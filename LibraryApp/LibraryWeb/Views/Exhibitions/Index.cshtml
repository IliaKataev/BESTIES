@{
    ViewBag.Title = "Exhibitions";
}

<h2>Exhibitions</h2>

<div class="container-fluid">
    <div class="row">
        <!-- Левая колонка: создание / редактирование -->
        <div class="col-3">
            <div class="mb-3">
                <input type="text" id="searchExhibition" class="form-control" placeholder="Поиск выставки" />
            </div>
            <button id="createExhibition" class="btn btn-success w-100 mb-2">Создать выставку</button>
            <button id="editExhibition" class="btn btn-primary w-100 mb-2" disabled>Редактировать</button>
        </div>

        <!-- Правая колонка: перечень выставок -->
        <div class="col-9">
            <div id="exhibitionList" class="row g-3">
                <!-- Здесь динамически будут карточки выставок -->
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания/редактирования выставки -->
<div class="modal fade" id="exhibitionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Создать выставку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exhibitionName" class="form-label">Название выставки</label>
                    <input type="text" id="exhibitionName" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Выберите книги</label>
                    <div id="bookSelection" class="row g-2">
                        <!-- сюда будут подставляться книги с API -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveExhibition" class="btn btn-success">Сохранить</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра коллекции выставки -->
<div class="modal fade" id="viewCollectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="collectionModalTitle">Коллекция выставки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="collectionBooks" class="row g-2">
                    <!-- карточки книг будут подставляться сюда -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>


<script>
    let selectedExhibitionId = null;
    let selectedBooks = new Set(); // выбранные книги

    // Показать коллекцию выставки
            async function viewCollection(exhibitionId) {
        // Получаем данные выставки
        const exhibitionRes = await fetch(`https://localhost:7055/api/exhibitions/${exhibitionId}`);
        const exhibition = await exhibitionRes.json();

        // Получаем все книги с сервера (как в модалке создания/редактирования)
        const booksRes = await fetch('https://localhost:7055/api/books');
        const allBooks = await booksRes.json();

        // Создаем Map для быстрого поиска книг по ключу
        const bookMap = new Map();
        allBooks.forEach(b => bookMap.set(b.key, b));

        const container = document.getElementById('collectionBooks');
        container.innerHTML = '';

        // Получаем ключи книг из выставки
        const bookKeys = exhibition.books?.map(b => b.bookKey) || [];

        // Отображаем книги из коллекции
        bookKeys.forEach(bookKey => {
            const book = bookMap.get(bookKey);

            // Если книга найдена, показываем с полными данными
            if (book) {
                // Получаем первую обложку или используем default
                const coverFile = book.covers?.[0]?.coverFile || 'default';

                const col = document.createElement('div');
                col.className = 'col-4 mb-3';
                col.innerHTML = `
                    <div class="card book-card h-100">
                        <img src="/images/covers/${coverFile}.png"
                             class="card-img-top"
                             alt="${book.title}"
                             style="height: 150px; object-fit: cover;">
                        <div class="card-body text-center">
                            <h6 class="card-title">${book.title}</h6>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            } else {
                // Если книга не найдена, показываем минимальную информацию
                const col = document.createElement('div');
                col.className = 'col-4 mb-3';
                col.innerHTML = `
                    <div class="card book-card h-100">
                        <img src="/images/covers/default.png"
                             class="card-img-top"
                             alt="${bookKey}"
                             style="height: 150px; object-fit: cover;">
                        <div class="card-body text-center">
                            <h6 class="card-title">${bookKey}</h6>
                            <p class="card-text text-muted small">Информация о книге отсутствует</p>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            }
        });

        document.getElementById('collectionModalTitle').textContent = `Коллекция: ${exhibition.name}`;
        new bootstrap.Modal(document.getElementById('viewCollectionModal')).show();
    }


    // Загрузить выставки
    async function loadExhibitions() {
        const res = await fetch('https://localhost:7055/api/exhibitions');
        const data = await res.json();

        const container = document.getElementById('exhibitionList');
        container.innerHTML = ''; // очищаем контейнер, чтобы дубли не появлялись

        data.forEach(ex => {
            const div = document.createElement('div');
            div.className = 'col-md-4';

            const coverFile = ex.coverBookKey ? ex.coverBookKey : 'default';

            div.innerHTML = `
                <div class="card exhibition-card" data-id="${ex.exhibitionId}" style="cursor:pointer; position:relative;">
                    <img src="/images/covers/${coverFile}.png" class="card-img-top" alt="${ex.name}">
                    <div class="card-body d-flex flex-column align-items-center">
                        <h5 class="card-title mb-2 text-center">${ex.name}</h5>
                    </div>
                    <span class="view-collection-icon"
                          style="position:absolute; top:5px; right:5px; cursor:pointer; font-size:1.2rem;"
                          title="Смотреть коллекцию">🔍</span>
                </div>
            `;

            container.appendChild(div);

            const card = div.querySelector('.exhibition-card');

            // Выбор карточки выставки
            card.addEventListener('click', () => {
                selectedExhibitionId = ex.exhibitionId;
                document.querySelectorAll('.exhibition-card').forEach(c => c.classList.remove('border-primary'));
                card.classList.add('border', 'border-primary');
                document.getElementById('editExhibition').disabled = false;
            });

            // Иконка "Смотреть коллекцию"
            div.querySelector('.view-collection-icon').addEventListener('click', (e) => {
                e.stopPropagation(); // чтобы не срабатывал клик на карточку
                viewCollection(ex.exhibitionId);
            });
        });
    }

    // Фильтр по названию
    document.getElementById('searchExhibition').addEventListener('input', (e) => {
        const filter = e.target.value.toLowerCase();
        document.querySelectorAll('.exhibition-card').forEach(card => {
            const title = card.querySelector('.card-title').textContent.toLowerCase();
            card.parentElement.style.display = title.includes(filter) ? '' : 'none';
        });
    });

    // Загрузка книг для модального окна создания/редактирования
    async function loadBooksForModal(selected = []) {
        const res = await fetch('https://localhost:7055/api/books');
        const books = await res.json();

        const container = document.getElementById('bookSelection');
        container.innerHTML = '';

        books.forEach(b => {
            const col = document.createElement('div');
            col.className = 'col-4';
            col.innerHTML = `
                <div class="card book-card" data-key="${b.key}" style="cursor:pointer;">
                    <img src="/images/covers/${b.covers?.[0]?.coverFile || 'default'}.png" class="card-img-top">
                    <div class="card-body text-center">
                        <small>${b.title}</small>
                    </div>
                </div>
            `;
            container.appendChild(col);

            const card = col.querySelector('.book-card');

            // если книга уже выбрана, подсвечиваем
            if (selected.includes(b.key)) {
                card.classList.add('border', 'border-primary');
                selectedBooks.add(b.key);
            }

            card.addEventListener('click', () => {
                const key = card.dataset.key;
                if (selectedBooks.has(key)) {
                    selectedBooks.delete(key);
                    card.classList.remove('border', 'border-primary');
                } else {
                    selectedBooks.add(key);
                    card.classList.add('border', 'border-primary');
                }
            });
        });
    }

    // Создать выставку
    document.getElementById('createExhibition').addEventListener('click', () => {
        selectedExhibitionId = null;
        selectedBooks.clear();
        document.getElementById('exhibitionName').value = '';
        loadBooksForModal([]);
        openModal('Создать выставку');
    });

    // Редактировать выставку
    document.getElementById('editExhibition').addEventListener('click', async () => {
        if (!selectedExhibitionId) return;

        const res = await fetch(`https://localhost:7055/api/exhibitions/${selectedExhibitionId}`);
        const ex = await res.json();

        document.getElementById('exhibitionName').value = ex.name;

        selectedBooks.clear();
        const bookKeys = ex.books?.map(b => b.bookKey) || [];
        bookKeys.forEach(k => selectedBooks.add(k));

        await loadBooksForModal(bookKeys);

        openModal('Редактировать выставку');
    });

    // Открыть модальное окно создания/редактирования
    function openModal(title) {
        document.getElementById('modalTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('exhibitionModal')).show();
    }

    // Сохранить выставку
    document.getElementById('saveExhibition').addEventListener('click', async () => {
        const name = document.getElementById('exhibitionName').value.trim();
        if (!name || selectedBooks.size === 0) {
            alert('Введите название и выберите хотя бы одну книгу');
            return;
        }

        const payload = {
            name,
            bookKeys: Array.from(selectedBooks)
        };

        if (selectedExhibitionId) {
            await fetch(`https://localhost:7055/api/exhibitions/${selectedExhibitionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            await fetch('https://localhost:7055/api/exhibitions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        bootstrap.Modal.getInstance(document.getElementById('exhibitionModal')).hide();
        await loadExhibitions();
    });

    // Загрузка выставок при старте
    document.addEventListener('DOMContentLoaded', loadExhibitions);
</script>



<style>
    .exhibition-card {
        transition: border 0.2s;
        height: 250px;
        display: flex;
        flex-direction: column;
    }

        .exhibition-card img {
            object-fit: cover;
            height: 150px;
            width: 100%;
        }

        .exhibition-card .card-body {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .exhibition-card:hover {
            border: 2px solid #007bff;
        }

    .book-card {
        height: 180px;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition: border 0.2s;
    }

        .book-card img {
            object-fit: cover;
            height: 120px;
            width: 100%;
        }

        .book-card .card-body {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .book-card:hover {
            border: 2px solid #007bff;
        }

</style>
