@model IEnumerable<LibraryWeb.Models.CustomerDto>

<h2>Manage Customers</h2>

<div style="display:flex; gap:20px; height:600px;">

    <!-- Левая колонка: поиск + действия -->
    <div style="width:250px; border:1px solid #ccc; padding:10px;">
        <h4>Search</h4>

        <div>
            <label>ID:</label><br />
            <input type="text" id="search-id" placeholder="C100..." style="width:100%;" />
        </div>

        <div style="margin-top:10px;">
            <label>Name:</label><br />
            <input type="text" id="search-name" placeholder="Введите имя" style="width:100%;" />
        </div>

        <button id="search-button" class="btn btn-secondary mt-2">Search</button>

        <div style="margin-top:15px; display:flex; gap:10px;">
            <button id="edit-btn" class="btn btn-warning" disabled>Edit</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                Add
            </button>
        </div>
    </div>

    <!-- Правая колонка: таблица -->
    <div style="flex:1; overflow:auto;">
        <table class="table table-striped" id="customers-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Zip</th>
                    <th>City</th>
                    <th>Phone</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model)
                {
                    <tr data-id="@c.Customerid" style="cursor:pointer;">
                        <td>@($"C{c.Customerid:D3}")</td>
                        <td>@c.Name</td>
                        <td>@c.Address</td>
                        <td>@c.Zip</td>
                        <td>@c.City</td>
                        <td>@c.Phone</td>
                        <td>@c.Email</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- ================= ADD MODAL ================= -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="add-customer-form">
                <div class="modal-header">
                    <h5 class="modal-title">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2"><label>Name</label><input name="Name" class="form-control" required /></div>
                    <div class="mb-2"><label>Address</label><input name="Address" class="form-control" /></div>
                    <div class="mb-2"><label>Zip</label><input name="Zip" class="form-control" /></div>
                    <div class="mb-2"><label>City</label><input name="City" class="form-control" /></div>
                    <div class="mb-2"><label>Phone</label><input name="Phone" class="form-control" /></div>
                    <div class="mb-2"><label>Email</label><input name="Email" type="email" class="form-control" /></div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" type="submit">Add</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="edit-customer-form">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="Customerid" />

                    <div class="mb-2"><label>Name</label><input name="Name" class="form-control" required /></div>
                    <div class="mb-2"><label>Address</label><input name="Address" class="form-control" /></div>
                    <div class="mb-2"><label>Zip</label><input name="Zip" class="form-control" /></div>
                    <div class="mb-2"><label>City</label><input name="City" class="form-control" /></div>
                    <div class="mb-2"><label>Phone</label><input name="Phone" class="form-control" /></div>
                    <div class="mb-2"><label>Email</label><input name="Email" type="email" class="form-control" /></div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-warning" type="submit">Save</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const rows = document.querySelectorAll("#customers-table tbody tr");
            const editBtn = document.getElementById("edit-btn");
            let selectedRow = null;

            /* ===== Search ===== */
                    document.getElementById("search-button").addEventListener("click", () => {

            let idFilter = document.getElementById("search-id").value.trim().toLowerCase();
            const nameFilter = document.getElementById("search-name").value.toLowerCase();

            if (idFilter.length && isNaN(idFilter[0])) {
                idFilter = idFilter.substring(1);
            }

            rows.forEach(row => {
                let rowId = row.cells[0].innerText.toLowerCase();
                if (isNaN(rowId[0])) {
                    rowId = rowId.substring(1);
                }

                const name = row.cells[1].innerText.toLowerCase();

                row.style.display =
                    rowId.includes(idFilter) && name.includes(nameFilter)
                        ? ""
                        : "none";
            });
        });


            /* ===== Select customer ===== */
            rows.forEach(row => {
                row.addEventListener("click", () => {
                    rows.forEach(r => r.classList.remove("table-active"));
                    row.classList.add("table-active");
                    selectedRow = row;
                    editBtn.disabled = false;
                });
            });

            /* ===== Open edit modal ===== */
            editBtn.addEventListener("click", () => {
                if (!selectedRow) return;

                const form = document.getElementById("edit-customer-form");

                form.Customerid.value = selectedRow.dataset.id;
                form.Name.value = selectedRow.cells[1].innerText;
                form.Address.value = selectedRow.cells[2].innerText;
                form.Zip.value = selectedRow.cells[3].innerText;
                form.City.value = selectedRow.cells[4].innerText;
                form.Phone.value = selectedRow.cells[5].innerText;
                form.Email.value = selectedRow.cells[6].innerText;

                new bootstrap.Modal(document.getElementById("editCustomerModal")).show();
            });

            /* ===== Save edited customer ===== */
            document.getElementById("edit-customer-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const f = e.target;

                const customer = {
                    Customerid: parseInt(f.Customerid.value),
                    Name: f.Name.value,
                    Address: f.Address.value,
                    Zip: f.Zip.value,
                    City: f.City.value,
                    Phone: f.Phone.value,
                    Email: f.Email.value
                };

                const apiUrl = "https://localhost:7055/api/customers";

                const res = await fetch(`${apiUrl}/${customer.Customerid}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(customer)
                });

                if (!res.ok) {
                    alert("Error saving customer");
                    return;
                }

                location.reload();
            });

            /* ===== Add customer ===== */
            document.getElementById("add-customer-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const f = e.target;

                const customer = {
                    Name: f.Name.value,
                    Address: f.Address.value,
                    Zip: f.Zip.value,
                    City: f.City.value,
                    Phone: f.Phone.value,
                    Email: f.Email.value
                };

                const apiUrl = "https://localhost:7055/api/customers";

                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(customer)
                });

                if (!res.ok) {
                    alert("Error adding customer");
                    return;
                }

                location.reload();
            });

        });
    </script>
}
